<?xml version="1.0" encoding="UTF-8"?>
<project name="protobuf" default="setup">

   <target name="clone" depends="check protobuf" unless="dir.exists">
      <git command = "clone">
         <args>
            <arg value = "https://github.com/android/platform_external_protobuf/" />
         </args>
      </git> 
      <!-- clean standard makefile -->
      <delete file="platform_external_protobuf/Android.mk" />
      <!-- configure, make and install protobuf -->
      <exec dir="platform_external_protobuf/" executable="./configure" failonerror="true">
         <arg value="--prefix=/usr/"/>
      </exec>
      <exec dir="platform_external_protobuf/" executable="make" failonerror="true"/>
      <exec dir="platform_external_protobuf/" executable="sudo" failonerror="true">
         <arg value="make"/>
         <arg value="install"/>
      </exec>
   </target>
   

   <target name="check protobuf">
    <condition property="dir.exists">
      <available file="platform_external_protobuf/" type="dir"/>
    </condition>
  </target>
  
  <target name="copy">
      <echo message="NDK: ${ndk.dir}" />
      <!-- put protobuf files to standard include path -->
      <copy todir="${ndk.dir}/platforms/android-9/arch-arm/usr/include/">
         <fileset dir="platform_external_protobuf/src/"/>
      </copy>
  </target>
  
  
  <target name="buildlib">
      <!-- put protobuf files to standard include path -->
      <copy todir="platform_external_protobuf/jni/">
         <fileset dir="../framework/libraries/AndroidPrebuilt/protobuf/jni/"/>
      </copy>
      <copy file="../framework/libraries/AndroidPrebuilt/protobuf/Android.mk" todir="platform_external_protobuf/" overwrite="true" />
      <exec dir="platform_external_protobuf/" executable="ndk-build" failonerror="true"/>
      <copy file="platform_external_protobuf/obj/local/armeabi/libprotobufLiteStatic.a" todir="../framework/libraries/AndroidPrebuilt/protobuf"  overwrite="true"/>
      <copy file="platform_external_protobuf/obj/local/armeabi/libprotobufLiteShared.so" todir="../framework/libraries/AndroidPrebuilt/protobuf" overwrite="true" />
  </target>
  
  
  <target name="setup" depends="clone, buildlib, copy" />
 


   <macrodef name = "git">
      <attribute name = "command" />
      <attribute name = "dir" default = "" />
      <element name = "args" optional = "true" />
      <sequential>
         <echo message = "git @{command}" />
         <exec executable = "git" dir = "@{dir}">
               <arg value = "@{command}" />
               <args/>
         </exec>
       </sequential>
   </macrodef>

</project>

   

   
